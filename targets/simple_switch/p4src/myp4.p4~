// This is P4 sample source for myp4
// Fill in these files with your P4 code

#include "includes/headers.p4"
#include "includes/parser.p4"


action _drop() {
    drop();
}

action _nop() {
}

header_type intrinsic_metadata_t {
    fields {
        mcast_grp : 4;
        egress_rid : 4;
        mcast_hash : 16;
        lf_field_list: 32;
    }
}

metadata intrinsic_metadata_t intrinsic_metadata;


#define MAC_LEARN_RECEIVER 1024

field_list mac_learn_digest {
    ethernet.srcAddr;
    standard_metadata.ingress_port;
}
action mac_learn() {
    generate_digest(MAC_LEARN_RECEIVER, mac_learn_digest);
}
table smac {
    reads {
        ethernet.srcAddr : exact;
    }
    actions {mac_learn; _nop;}
    size : 512;
}


action forward(port) {
    modify_field(standard_metadata.egress_spec, port);
}
action broadcast() {
    modify_field(intrinsic_metadata.mcast_grp, 1);
}
table dmac {
    reads {
        ethernet.dstAddr : exact;
    }
    actions {
        forward;
	broadcast;
    }
    size : 512;
}

/*action set_vlan_tag(vid) {
    add_header(vlan); 
    modify_field(vlan.vid, vid);
    modify_field(vlan.etherType, ETHERTYPE_VLAN);
    modify_field(ethernet.etherType, ETHERTYPE_VLAN);
}

table add_vlan {
    reads {
	standard_metadata.ingress_port : exact;
    }
    actions {
	set_vlan_tag;
	_nop;
    }
    size : 512;
}
*/

table mcast_src_pruning {
    reads {
        standard_metadata.instance_type : exact;
    }
    actions {_nop; _drop;}
    size : 1;
}
/*
action pop_vlan() {
    remove_header(vlan);
    modify_field(ethernet.etherType, ETHERTYPE_IPV4);
}
table pop_vlan {
    reads {
        standard_metadata.egress_port : exact;
    }
    actions {pop_vlan;}
    size : 1;
}
*/

action rewrite_mac() {
    
}
table send_frame {
    reads {
	standard_metadata.egress_port : exact;
        //vlan.vid: exact;
    }
    actions {
	rewrite_mac;
	_drop;
    }
    size : 512;
}

control ingress {
    apply(smac);
    apply(dmac);
    //apply(add_vlan);
}

control egress {
    /*if (standard_metadata.ingress_port == standard_metadata.egress_port) {
	apply(mcast_src_pruning);
    }*/
    apply(send_frame);
    //apply(pop_vlan);
    
}

